version: "3.7"
services:
  app:
    image: bresnow/remix-gun_dev:${VERSION:-latest}
    volumes:
      - packages:/app/packages
      - config:/app/config
      - node_modules:/app/node_modules
      - public:/app/packages/remix/public
    networks:
      - socket-proxy
      - edge
      - public
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=public
        - traefik.constraint-label=public
        - traefik.http.routers.remix-gun-app-${NUMBER:-0}.rule=Host(`${DOMAIN:-remix-gun.fltngmmth.com}`)
        - traefik.http.routers.remix-gun-app-${NUMBER:-0}.entrypoints=http,https
        - traefik.http.routers.remix-gun-app-${NUMBER:-0}.middlewares=https-redirect
        - traefik.http.routers.remix-gun-app-${NUMBER:-0}.tls=true
        - traefik.http.routers.remix-gun-app-${NUMBER:-0}.tls.certresolver=le
        - traefik.http.services.remix-gun-app-${NUMBER:-0}.loadbalancer.server.port=${PORT:-3333}
volumes:
  public:
    driver: local-persist
    driver_opts:
      mountpoint: ${PWD}/packages/remix/public
  packages:
    driver: local-persist
    driver_opts:
      mountpoint: ${PWD}/packages
  node_modules:
    driver: local-persist
    driver_opts:
      mountpoint: ${PWD}/node_modules
  config:
    driver: local-persist
    driver_opts:
      mountpoint: ${PWD}/config

networks:
  edge:
    external: true
  socket-proxy:
    external: true
  public:
    external: true
